name: Fancode Events Auto-Update

on:
  schedule:
    - cron: '0 */12 * * *'  # every 12 hours
  workflow_dispatch:

jobs:
  update-fancode:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fetch latest fancode.m3u and update php.m3u
        run: |
          # Fetch fancode.m3u from GitHub
          curl -sL -o fancode.m3u "https://raw.githubusercontent.com/drmlive/fancode-live-events/refs/heads/main/fancode.m3u"

          # Remove old Fancode section
          sed -i '/#FANCODE-BEGIN/,/#FANCODE-END/d' php.m3u

          # Start new block
          echo "#FANCODE-BEGIN" > fancode_processed.m3u

          # Convert and append entries with tvg-name
          awk 'BEGIN { OFS="\n" }
            /^#EXTINF:-1,/ {
              title=substr($0, index($0, ",") + 1)
              print "#EXTINF:-1 tvg-name=\"" title "\", " title
              next
            }
            /^[^#]/ {
              print $0
            }
          ' fancode.m3u >> fancode_processed.m3u

          # End block
          echo "#FANCODE-END" >> fancode_processed.m3u

          # Append updated block to php.m3u
          cat fancode_processed.m3u >> php.m3u

          # Cleanup
          rm fancode_processed.m3u fancode.m3u

      - name: Commit and Push updated M3U
        run: |
          git config user.name "Fancode Bot"
          git config user.email "actions@github.com"

          git add php.m3u
          git commit -m "ğŸ” Auto-update Fancode live events" || echo "No changes to commit"
          git push
