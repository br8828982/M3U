name: Fancode Events Auto-Update

on:
  schedule:
    - cron: '0 */12 * * *' # every 12 hours
  workflow_dispatch:

jobs:
  update-fancode:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fetch latest fancode.m3u and update php.m3u
        run: |
          # Fetch the raw fancode.m3u from GitHub
          curl -sL -o fancode.m3u "https://raw.githubusercontent.com/drmlive/fancode-live-events/refs/heads/main/fancode.m3u"

          # Remove previous Fancode section
          sed -i '/#FANCODE-BEGIN/,/#FANCODE-END/d' php.m3u

          # Start new Fancode block
          echo "#FANCODE-BEGIN" > fancode_processed.m3u
          echo "#EXTM3U" >> fancode_processed.m3u

          # Format each EXTINF block with proper tvg-name
          awk '
            BEGIN { RS=""; FS="\n" }
            {
              for (i = 1; i <= NF; i++) {
                if ($i ~ /^#EXTINF:-1,/) {
                  line = $i
                  event = substr(line, index(line, ",") + 1)
                  gsub(/^#EXTINF:-1,/, "#EXTINF:-1 tvg-name=\"" event "\"", line)
                  print line >> "fancode_processed.m3u"
                  print $(i+1) >> "fancode_processed.m3u"
                }
              }
            }
          ' fancode.m3u

          # End block marker
          echo "#FANCODE-END" >> fancode_processed.m3u

          # Append to main M3U
          cat fancode_processed.m3u >> php.m3u

          # Cleanup
          rm fancode_processed.m3u

      - name: Commit and Push updated M3U
        run: |
          git config user.name "Fancode Bot"
          git config user.email "actions@github.com"

          git add php.m3u
          git commit -m "üîÅ Auto-update Fancode live events"
          git push
